<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Script Libraries -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="underscore-min.js" type="text/javascript"></script>
    <script src="underscore.string.min.js" type="text/javascript"></script>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css"
      href="https://fonts.googleapis.com/css?family=Open+Sans:400,600">
    <link rel="stylesheet" type="text/css" href="styles.css"> 
    <title>Success of Movies</title>
  </head>
  <body>
   
    <!-- Top Containter -->
    <div id ="header">
      <h1><div id = "title"></div></h1>
    </div>

        
    <div id="sidebar1">
      <h2>Studio Names</h2>
      <div id="studiolegend"></div>
    </div>
      
    <div id="sidebar">
       <h2>Movie Genres</h2>
      <div id="genrelegend"></div>
    </div>
      

    <!-- Visualization Container -->
    <div id="main">
      <div id="chart">
        <div id="explanation" style="visibility: hidden;">
          <span id="percentage"></span><br/>
          of gross revenue for <br/>
          <span id="name"></span><br/>
          out of the total.
        </div>
      </div>
         <div id="sequence"></div>
    </div>
    
<!-- Javascript starts -->
<script>

// Function to load sunburst diagram
function load_data (filename, is_changed) {
  // SVG dimenstions
  var width = 780, height = 780, radius = 380;
  
  // Breadcrumb dimensions: width, height, spacing, width of tip/tail.
  var b = {
    w: 250, h: 40, s: 3, t: 10
  };

  var li = {
    w: 200, h: 30, s: 3, r: 3
  };

  //Colors
   var color_domain = ["Columbia","Disney","DreamWorks",
          "Fox", "Happy Madison","Independent",
          "Legendary Pictures","MGM","Paramount",
          "Pixar","Relativity Media","Sony",
          "Spyglass Entertainment", "Summit","The Weinstein Company",
          "Universal","Warner Bros.", "Other Studios",
          
          "Action","Adventure","Animation",
          "Comedy","Drama", "Horror",
      "Romance","Thriller","Other"];
  
  var studios = ["Columbia","Disney","DreamWorks",
          "Fox", "Happy Madison","Independent",
          "Legendary Pictures","MGM","Paramount",
          "Pixar","Relativity Media","Sony",
          "Spyglass Entertainment", "Summit","The Weinstein Company",
          "Universal","Warner Bros.", "Other Studios"]; 
  
  var genres = ["Action","Adventure","Animation",
          "Comedy","Drama", "Horror",
      "Romance","Thriller","Other"];
        
  var color_range = ["#ffbb78","#98df8a","#d62728",
          "#9467bd","#3b3ef6","#613b10",
          "#e377c2","#7f7f7f","#25cfc3",
          "#6b6ecf","#637939","#8ca252",
          "#b5cf6b","#8c6d31","#bd9e39",
          "#e7ba52","#3297c9", "#FF6600",
          
          "#f28888","#FFB347","#EBEB99",
          "#B2FF99","#b1faf1","#D1B2D1",
      "#F0B2E0","#AEC6CF","#B2B2B2"];
  function colorObj(num){
  var color;
  for(var i = num; i < color_range.length; i++){
    color = {};
    for(var j = num; j < color_domain.length; j++){
      color[color_domain[j]] = color_range[j];
    }
    return color
  }}
  var scolors = colorObj(0);
  var gcolors = colorObj(18);
  // console.log(colorObj());
  
  //sets random color out of the four ranges 
  var random_color = d3.scale.ordinal().range( ["#331433", "#662966", "#993D99", "#CC52CC"] );
  
  //sets the color of a range to a specific domain value
  var color = d3.scale.ordinal().domain(color_domain).range(color_range);

  // Sets svg in chart
    var vis = d3.select("#chart").append("svg:svg")
    //.attr("width", width)
    //.attr("height", height)
  .attr("width", 1)
    .attr("height", height)
    .append("svg:g")
    .attr("id", "container")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
  
  if(is_changed == 1) {
    d3.select("#chart").select("svg").transition()
    .attr("width", width)
    .duration(1500);
  }
  else {
  d3.select("#chart").select("svg").attr("width", width);
  }

  var partition = d3.layout.partition()
    .sort(null)
    .size([2 * Math.PI, radius * radius])
    .value(function(d) { return d.Gross; });

  // creates arc for values in the data
  var arc = d3.svg.arc()
    .startAngle(function(d) { return d.x; })
    .endAngle(function(d) { return d.x + d.dx; })
    .innerRadius(function(d) { return Math.sqrt(d.y); })
    .outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });
  
  var totalSize = 0; 
  
  //Load JSON to preppedData    
  var preppedData;
  d3.json(filename, function(error, json){
     preppedData = json;

  initializeBreadcrumbTrail();
  drawGenreLegend();
  drawStudioLegend();
  // d3.select("#togglelegend").on("click", toggleLegend);

  vis.append("svg:circle")
	 .attr("r", radius)
	 .style("opacity", 0);
  
  var div = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);

  var films = [];
  var films_color = [];
    var path = vis.datum(preppedData).selectAll("path")
      .data(partition.nodes)
      .enter().append("path")
      .attr("display", function(d) { return d.depth ? null : "none"; }) // hide inner ring
      .attr("d", arc)
      .attr("class", function(d) { return (d.children ? d : d.parent).name; })
      .style("stroke", "#fff")
      .style("fill", function(d) { 
        var the_name = d.name;
        if(studios.indexOf(the_name) > -1) {
          return color(the_name);
        }
        else {
          if(genres.indexOf(the_name) > -1) {
      for(var i = 0; i < d.children.length; i++) {
        films.push(d.children[i].name);
        films_color.push(color(the_name));
      }
      return color(the_name);
      }     
      else {
      return films_color[films.indexOf(the_name)];
      }
    }
      })
      .style("fill-rule", "evenodd")
    .style("opacity", function(d) {
    var the_name = d.name; 
    if(color_domain.indexOf(the_name) > -1) {
      return 1;
    }
    else {
      return 0.7;
    }
    })
      .on("mouseover", mouseover);

    d3.select("#container").on("mouseleave", mouseleave);
    totalSize = path.node().__data__.value;
// Fade all but the current sequence, and show it in the breadcrumb trail.
function mouseover(d) {

  var percentage = (100 * d.value / totalSize).toPrecision(3);
  var percentageString = percentage + "%";
  if (percentage < 0.1) {
    percentageString = "< 0.1%";
  }

  d3.select("#percentage")
      .text(percentageString);

  d3.select("#explanation")
      .style("visibility", "");

    d3.select("#name")
      .text(d.name);

  var sequenceArray = getAncestors(d);
  updateBreadcrumbs(sequenceArray, percentageString);

  // Fade all the segments.
  d3.selectAll("path")
      .style("opacity", 0.3);

  // Then highlight only those that are an ancestor of the current segment.
  vis.selectAll("path")
      .filter(function(node) {
                return (sequenceArray.indexOf(node) >= 0);
              })
      .style("opacity", 1);
}


 function mouseleave(d) {

  // Hide the breadcrumb trail
  d3.select("#trail")
      .style("visibility", "hidden");

  // Deactivate all segments during transition.
  d3.selectAll("path").on("mouseover", null);

  // Transition each segment to full opacity and then reactivate it.
  d3.selectAll("path")
      .transition()
      .duration(1000)
      .style("opacity", function(d) {
    if(d.children != null) {
      return 1; 
    }
    else {
      return 0.7;
    }
    })
      .each("end", function() {
              d3.select(this).on("mouseover", mouseover);
            });

  d3.select("#explanation")
      .style("visibility", "hidden");
}

 // helper function click to handle mouseleave events/animations
  function click(d) {
    // Deactivate all segments then retransition each segment to full opacity.
    svg.selectAll("path").on("mouseover", null);
    svg.selectAll("path")
      .transition()
      .duration(1000)
      .attr("opacity", 1)
      .each("end", function() {
        d3.select(this).on("mouseover", mouseover);
      });

    // hide summary and breadcrumbs if visible
      d3.select("#trail").style("visibility", "hidden");
      d3.select("#explanation").style("visibility", "hidden");
  }


// Given a node in a partition layout, return an array of all of its ancestor
// nodes, highest first, but excluding the root.
  function getAncestors(node) {
    var path = [];
    var current = node;
    while (current.parent) {
      path.unshift(current);
      current = current.parent;
    }
    return path;
  }

function initializeBreadcrumbTrail() {
  // Add the svg area.
  var trail = d3.select("#sequence").append("svg:svg")
      .attr("width", 1000)
      .attr("height", 50)
      .attr("id", "trail");
  // Add the label at the end, for the percentage.
  trail.append("svg:text")
    .attr("id", "endlabel")
    .style("fill", "#000");
}

// Generate a string that describes the points of a breadcrumb polygon.
function breadcrumbPoints(d, i) {
  var points = [];
  points.push("0,0");
  points.push(b.w + ",0");
  points.push(b.w + b.t + "," + (b.h / 2));
  points.push(b.w + "," + b.h);
  points.push("0," + b.h);
  if (i > 0) { // Leftmost breadcrumb; don't include 6th vertex.
    points.push(b.t + "," + (b.h / 2));
  }
  return points.join(" ");
}

// Update the breadcrumb trail to show the current sequence and percentage.
function updateBreadcrumbs(nodeArray, percentageString) {

  // Data join; key function combines name and depth (= position in sequence).
  var g = d3.select("#trail")
      .selectAll("g")
      .data(nodeArray, function(d) { return d.name + d.depth; });

  // Add breadcrumb and label for entering nodes.
  var entering = g.enter().append("svg:g");

  var the_films = [];
  var the_films_color = [];
  entering.append("svg:polygon")
      .attr("points", breadcrumbPoints)
      .style("fill", function(d) { 
        var the_name = d.name;
        if(studios.indexOf(the_name) > -1) {
          return color(the_name);
        }
        else {
          if(genres.indexOf(the_name) > -1) {
      for(var i = 0; i < d.children.length; i++) {
        the_films.push(d.children[i].name);
        the_films_color.push(color(the_name));
      }
      return color(the_name);
      }     
      else {
      return the_films_color[the_films.indexOf(the_name)];
      }
    }
      })
    .style("opacity", function(d) {
    var the_name = d.name; 
    if(color_domain.indexOf(the_name) > -1) {
      return 1;
    }
    else {
      return 0.7;
    }
    })

  entering.append("svg:text")
      .attr("x", (b.w + b.t) / 2)
      .attr("y", b.h / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text(function(d) { return d.name; });

  // Set position for entering and updating nodes.
  g.attr("transform", function(d, i) {
    return "translate(" + i * (b.w + b.s) + ", 0)";
  });

  // Remove exiting nodes.
  g.exit().remove();

  // Now move and update the percentage at the end.
  d3.select("#trail").select("#endlabel")
      .attr("x", (nodeArray.length + 0.5) * (b.w + b.s))
      .attr("y", b.h / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text(percentageString);

  // Make the breadcrumb trail visible, if it's hidden.
  d3.select("#trail")
      .style("visibility", "");

}

function drawStudioLegend() {
  // Dimensions of legend item: width, height, spacing, radius of rounded rect.

  var legend = d3.select("#studiolegend").append("svg:svg")
      .attr("width", 1)
      .attr("height", 18 * (li.h + li.s));

  if (is_changed == 1) {
  d3.select("#studiolegend").select("svg")
  .transition().attr("width", li.w).duration(1500);
  }
  else {
    d3.select("#studiolegend").select("svg").attr("width", li.w);
  }
  
  var g = legend.selectAll("g")
      .data(d3.entries(scolors))
            .enter().append("svg:g")
           .attr("transform", function(d, i) {
              return "translate(0," + i * (li.h + li.s) + ")";
           })

  g.append("svg:rect")
      .attr("rx", li.r)
      .attr("ry", li.r)
      .attr("width", li.w)
      .attr("height", li.h)
      .style("fill", function(d) { return d.value; });

  g.append("svg:text")
      .attr("x", li.w / 2)
      .attr("y", li.h / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text(function(d) { return d.key; });
}

function drawGenreLegend() {
  // Dimensions of legend item: width, height, spacing, radius of rounded rect.
  var legend = d3.select("#genrelegend").append("svg:svg")
      .attr("width", 1)
      .attr("height", 18 * (li.h + li.s));
    
  if (is_changed == 1) {
  d3.select("#genrelegend").select("svg")
  .transition().attr("width", li.w).duration(1500);
  }
  else {
    d3.select("#genrelegend").select("svg").attr("width", li.w);
  }

  var g = legend.selectAll("g")
     .data(d3.entries(gcolors))
     .enter().append("svg:g")
     .attr("transform", function(d, i) {
              return "translate(0," + i * (li.h + li.s) + ")";
           });

  g.append("svg:rect")
      .attr("rx", li.r)
      .attr("ry", li.r)
      .attr("width", li.w)
      .attr("height", li.h)
      .style("fill", function(d) { return d.value; });

  g.append("svg:text")
      .attr("x", li.w / 2)
      .attr("y", li.h / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text(function(d) { return d.key; });
}

function toggleLegend() {
  var legend = d3.select("#legend");
  if (legend.style("visibility") == "hidden") {
    legend.style("visibility", "");
  } else {
    legend.style("visibility", "hidden");
  }}


      });
      
      
    }
    
    function change_data (year, is_changed) {
     d3.select("#chart").select("svg").remove();
     d3.select("#studiolegend").select("svg").remove();
     d3.select("#genrelegend").select("svg").remove();
     d3.select("#sequence").select("svg").remove();
     load_data((year + ".json"), is_changed);
      $("a").removeClass("selected");
      $("#"+year).addClass("selected");
      console.log(year);
      document.getElementById('title').innerHTML = "Studio's Percentage Of Gross In " + year;
    }
    change_data(2011, 0);
    
</script>
    <div id="years">
    <ul>
      <li><a id="2011" class="" onclick = change_data(2011,1)>2011</a></li>
      <li><a id="2010" class="" onclick = change_data(2010,1)>2010</a></li> 
      <li><a id="2009" class="" onclick = change_data(2009,1)>2009</a></li>
      <li><a id="2008" class="" onclick = change_data(2008,1)>2008</a></li> 
      <li><a id="2007" class="" onclick = change_data(2007,1)>2007</a></li> 
    </ul>           
</div> 
 <div id ="footer">
      <h2>Cyndi Chin, Jessica Lee, Thomas Perz</h2>
      <h4>Our Story: By hovering over the studios in the center, you can see
	  the percentage of worldwide gross each studio made out of all the 
	  studios' worldwide gross. For each studio, it's outer layer represents the 
	  types of genres of the films the studio produced for that year. If you hover 
	  over the genres, you will see the percentage of the gross for that studio that 
	  they earned from that genre. The outermost layer represents the films in that genre
	  for the studio. If you hover over the films, you will see the percentage of the
	  gross for that studio for that genre that the film earn.</h4>
</div>

 
</body>
</html>