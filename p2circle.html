<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Sequences sunburst</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <link rel="stylesheet" type="text/css"
      href="https://fonts.googleapis.com/css?family=Open+Sans:400,600">
    <style>
    body {
  font-family: 'Open Sans', sans-serif;
  font-size: 12px;
  font-weight: 400;
  background-color: #fff;
  width: 960px;
  height: 700px;
  margin-top: 10px;
}

#main {
  float: left;
  width: 750px;
}

#sidebar {
  float: right;
  width: 100px;
}

#sequence {
  width: 600px;
  height: 70px;
}

#legend {
  padding: 10px 0 0 3px;
}

#sequence text, #legend text {
  font-weight: 600;
  fill: #fff;
}

#chart {
  position: relative;
}

#chart path {
  stroke: #fff;
}

#explanation {
  position: absolute;
  top: 260px;
  left: 305px;
  width: 140px;
  text-align: center;
  color: #666;
  z-index: -1;
}

#percentage {
  font-size: 2.5em;
}
</style>
  </head>
  <body>
    <div id="main">
      <div id="sequence"></div>
      <div id="chart">
        <div id="explanation" style="visibility: hidden;">
          <span id="percentage"></span><br/>
          of visits begin with this sequence of pages
        </div>
      </div>
    </div>
    <div id="sidebar">
      <input type="checkbox" id="togglelegend"> Legend<br/>
      <div id="legend" style="visibility: hidden;"></div>
    </div>

    <script src="underscore-min.js" type="text/javascript"></script>
<script src="underscore.string.min.js" type="text/javascript"></script>

<script>
      //*************************************************
      // SETUP DATA VIZ
      //*************************************************
      var width = 960, height = 700, radius = 300;

      var color = d3.scale.ordinal().range(['#74E600','#26527C','#61D7A4','#6CAC2B','#408AD2','#218359','#36D792','#679ED2','#B0F26D','#4B9500','#98F23D','#04396C','#007241']);

      var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height * .52 + ")");

      var partition = d3.layout.partition()
        .sort(null)
        .size([2 * Math.PI, radius * radius])
        .value(function(d) { return d.gross; });

      var arc = d3.svg.arc()
        .startAngle(function(d) { return d.x; })
        .endAngle(function(d) { return d.x + d.dx; })
        .innerRadius(function(d) { return Math.sqrt(d.y); })
        .outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });

      //*************************************************
      // GET THE CSV DATA
      //*************************************************
      d3.csv("movies2011convert.csv", function(error, data) {

        _.each(data, function(element, index, list){
            element.gross = +element.gross;
        });

        //*************************************************
        // THE FUNCTION
        //*************************************************
        function genJSON(csvData, groups) {

          var genGroups = function(data) {
            return _.map(data, function(element, index) {
              return { name : index, children : element };
            });
          };

          var nest = function(node, curIndex) {
            if (curIndex === 0) {
              node.children = genGroups(_.groupBy(csvData, groups[0]));
              _.each(node.children, function (child) {
                nest(child, curIndex + 1);
              });
            }
            else {
              if (curIndex < groups.length) {
                node.children = genGroups(
                  _.groupBy(node.children, groups[curIndex])
                );
                _.each(node.children, function (child) {
                  nest(child, curIndex + 1);
                });
              }
            }
            return node;
          };
          return nest({}, 0);
        }
        //*************************************************
        // CALL THE FUNCTION
        //*************************************************
        var preppedData = genJSON(data, ['studio', 'genre','film'])
console.log(JSON.stringify(preppedData));
        //*************************************************
        // LOAD THE PREPPED DATA IN D3
        //*************************************************

        var div = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);
        var path = svg.datum(preppedData).selectAll("path")
          .data(partition.nodes)
        .enter().append("path")
          .attr("display", function(d) { return d.depth ? null : "none"; }) // hide inner ring
          .attr("d", arc)
          .attr("class", function(d) { return (d.children ? d : d.parent).name; })
          .style("stroke", "#fff")
          .style("fill", function(d) { return color((d.children ? d : d.parent).name); })
          .style("fill-rule", "evenodd")
          .on("mouseover", function(d) {
        d3.select(this).style("opacity", "1")
      
            div.transition()    
                .duration(200)    
                .style("fill", "blue")
                .style("opacity", 1)  

            div .html(d.name)  
                .style("left", (d3.event.pageX) + "px")   
                .style("top", (d3.event.pageY - 28) + "px");

            })          
        .on("mouseout", function(d) {
        d3.select(this).style("opacity", ".5")    
            div.transition()    
                .duration(500)    
                .style("opacity", 0); 
        });


      });
</script>
  </body>
</html>
